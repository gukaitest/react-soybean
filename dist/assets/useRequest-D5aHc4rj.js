var O=Object.defineProperty;var j=(r,e,t)=>e in r?O(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var v=(r,e,t)=>j(r,typeof e!="symbol"?e+"":e,t);import{i as T,s as B,a as H,b as _,u as M}from"./subscribeFocus-C0kbgqSh.js";import{r as m,dN as x,e as N,ax as E,M as q,f as y,P as z}from"./index-BA7W61Th.js";import{a as D,i as U,d as $}from"./debounce-DMi07XbZ.js";import{a as V,u as p}from"./index-BykAnZC5.js";function F(r,e){var t=m.useRef({deps:e,obj:void 0,initialized:!1}).current;return(t.initialized===!1||!x(t.deps,e))&&(t.deps=e,t.obj=r(),t.initialized=!0),t.obj}var X=D,J=U,Q="Expected a function";function Y(r,e,t){var s=!0,n=!0;if(typeof r!="function")throw new TypeError(Q);return J(t)&&(s="leading"in t?!!t.leading:s,n="trailing"in t?!!t.trailing:n),X(r,e,{leading:s,maxWait:e,trailing:n})}var Z=Y;const G=N(Z),w=new Map,L=(r,e,t)=>{const s=w.get(r);s!=null&&s.timer&&clearTimeout(s.timer);let n;e>-1&&(n=setTimeout(()=>{w.delete(r)},e)),w.set(r,{...t,timer:n})},W=r=>w.get(r),A=new Map,k=r=>A.get(r),I=(r,e)=>{A.set(r,e),e.then(t=>(A.delete(r),t)).catch(()=>{A.delete(r)})},P={},K=(r,e)=>{P[r]&&P[r].forEach(t=>t(e))},b=(r,e)=>(P[r]||(P[r]=[]),P[r].push(e),function(){const s=P[r].indexOf(e);P[r].splice(s,1)}),ee=(r,{cacheKey:e,cacheTime:t=5*60*1e3,getCache:s,setCache:n,staleTime:i=0})=>{const u=m.useRef(),l=m.useRef(),f=(a,o)=>{n?n(o):L(a,t,o),K(a,o.data)},c=(a,o=[])=>s?s(o):W(a);return F(()=>{if(!e)return;const a=c(e);a&&Object.hasOwn(a,"data")&&(r.state.data=a.data,r.state.params=a.params,(i===-1||new Date().getTime()-a.time<=i)&&(r.state.loading=!1)),u.current=b(e,o=>{r.setState({data:o})})},[]),E(()=>{var a;(a=u.current)==null||a.call(u)}),e?{onBefore:a=>{const o=c(e,a);return!o||!Object.hasOwn(o,"data")?{}:i===-1||new Date().getTime()-o.time<=i?{data:o==null?void 0:o.data,error:void 0,loading:!1,returnNow:!0}:{data:o==null?void 0:o.data,error:void 0}},onMutate:a=>{var o;e&&((o=u.current)==null||o.call(u),f(e,{data:a,params:r.state.params,time:new Date().getTime()}),u.current=b(e,d=>{r.setState({data:d})}))},onRequest:(a,o)=>{let d=k(e);return d&&d!==l.current?{servicePromise:d}:(d=a(...o),l.current=d,I(e,d),{servicePromise:d})},onSuccess:(a,o)=>{var d;e&&((d=u.current)==null||d.call(u),f(e,{data:a,params:o,time:new Date().getTime()}),u.current=b(e,R=>{r.setState({data:R})}))}}:{}},te=(r,{debounceLeading:e,debounceMaxWait:t,debounceTrailing:s,debounceWait:n})=>{const i=m.useRef(),u=m.useMemo(()=>{const l={};return e!==void 0&&(l.leading=e),s!==void 0&&(l.trailing=s),t!==void 0&&(l.maxWait=t),l},[e,s,t]);return m.useEffect(()=>{if(n){const l=r.runAsync.bind(r);return i.current=$(f=>{f()},n,u),r.runAsync=(...f)=>new Promise((c,a)=>{var o;(o=i.current)==null||o.call(i,()=>{l(...f).then(c).catch(a)})}),()=>{var f;(f=i.current)==null||f.cancel(),r.runAsync=l}}return()=>{}},[n,u]),n?{onCancel:()=>{var l;(l=i.current)==null||l.cancel()}}:{}},re=(r,{loadingDelay:e,ready:t})=>{const s=m.useRef();if(!e)return{};const n=()=>{s.current&&clearTimeout(s.current)};return{onBefore:()=>(n(),t!==!1&&(s.current=setTimeout(()=>{r.setState({loading:!0})},e)),{loading:!1}),onCancel:()=>{n()},onFinally:()=>{n()}}},ne=(r,{pollingErrorRetryCount:e=-1,pollingInterval:t,pollingWhenHidden:s=!0})=>{const n=m.useRef(),i=m.useRef(),u=m.useRef(0),l=()=>{var f;n.current&&clearTimeout(n.current),(f=i.current)==null||f.call(i)};return q(()=>{t||l()},[t]),t?{onBefore:()=>(l(),null),onCancel:()=>{l()},onError:()=>{u.current+=1},onFinally:()=>{e===-1||e!==-1&&u.current<=e?n.current=setTimeout(()=>{!s&&!T()?i.current=B(()=>{r.refresh()}):r.refresh()},t):u.current=0},onSuccess:()=>{u.current=0}}:{}};function se(r,e){let t=!1;return(...s)=>{t||(t=!0,r(...s),setTimeout(()=>{t=!1},e))}}const ie=(r,{focusTimespan:e=5e3,refreshOnWindowFocus:t})=>{const s=m.useRef(),n=()=>{var i;(i=s.current)==null||i.call(s)};return m.useEffect(()=>{if(t){const i=se(r.refresh.bind(r),e);s.current=H(()=>{i()})}return()=>{n()}},[t,e]),E(()=>{n()}),{}},ue=(r,{retryCount:e,retryInterval:t})=>{const s=m.useRef(),n=m.useRef(0),i=m.useRef(!1);return e?{onBefore:()=>(i.current||(n.current=0),i.current=!1,s.current&&clearTimeout(s.current),null),onCancel:()=>{n.current=0,s.current&&clearTimeout(s.current)},onError:()=>{if(n.current+=1,e===-1||n.current<=e){const u=t??Math.min(1e3*2**n.current,3e4);s.current=setTimeout(()=>{i.current=!0,r.refresh()},u)}else n.current=0},onSuccess:()=>{n.current=0}}:{}},oe=(r,{throttleLeading:e,throttleTrailing:t,throttleWait:s})=>{const n=m.useRef(),i={};return e!==void 0&&(i.leading=e),t!==void 0&&(i.trailing=t),m.useEffect(()=>{if(s){const u=r.runAsync.bind(r);return n.current=G(l=>{l()},s,i),r.runAsync=(...l)=>new Promise((f,c)=>{var a;(a=n.current)==null||a.call(n,()=>{u(...l).then(f).catch(c)})}),()=>{var l;r.runAsync=u,(l=n.current)==null||l.cancel()}}return()=>{}},[s,e,t]),s?{onCancel:()=>{var u;(u=n.current)==null||u.cancel()}}:{}};class ae{constructor(e,t,s,n={}){v(this,"pluginImpls");v(this,"count",0);v(this,"state",{data:void 0,error:null,loading:!1,params:void 0,response:null});this.serviceRef=e,this.options=t,this.subscribe=s,this.initState=n,this.state={...this.state,loading:!t.manual,...n}}setState(e={}){this.state={...this.state,...e},this.subscribe()}runPluginHandler(e,...t){const s=this.pluginImpls.map(n=>{var i;return(i=n[e])==null?void 0:i.call(n,...t)}).filter(Boolean);return Object.assign({},...s)}async runAsync(...e){var u,l,f,c,a,o,d,R,C,S;this.count+=1;const t=this.count,{returnNow:s=!1,stopNow:n=!1,...i}=this.runPluginHandler("onBefore",e);if(n)return new Promise(()=>{});if(this.setState({loading:!0,params:e,...i}),s)return Promise.resolve(i.data);(l=(u=this.options).onBefore)==null||l.call(u,e);try{let{servicePromise:h}=this.runPluginHandler("onRequest",this.serviceRef.current,e);h||(h=this.serviceRef.current(...e));const g=await h;return t!==this.count?new Promise(()=>{}):(this.setState({data:g.data,error:null,loading:!1,response:g.response}),(c=(f=this.options).onSuccess)==null||c.call(f,g.data,e),this.runPluginHandler("onSuccess",g,e),(o=(a=this.options).onFinally)==null||o.call(a,e,g.data,null),t===this.count&&this.runPluginHandler("onFinally",e,g,null),g)}catch(h){const g=h;if(t!==this.count)return new Promise(()=>{});throw this.setState({data:null,error:g,loading:!1,response:h.response}),(R=(d=this.options).onError)==null||R.call(d,g,e),this.runPluginHandler("onError",h,e),(S=(C=this.options).onFinally)==null||S.call(C,e,void 0,g),t===this.count&&this.runPluginHandler("onFinally",e,void 0,h),h}}run(...e){this.runAsync(...e).catch(t=>{this.options.onError||console.error(t)})}cancel(){this.count+=1,this.setState({loading:!1}),this.runPluginHandler("onCancel")}refresh(){this.run(...this.state.params||[])}refreshAsync(){return this.runAsync(...this.state.params||[])}mutate(e){const t=_(e)?e(this.state.data):e;this.runPluginHandler("onMutate",t),this.setState({data:t})}}function ce(r,e={},t=[]){const{manual:s=!1,ready:n=!0,...i}=e,u={manual:s,ready:n,...i},l=y(r),f=V(),c=F(()=>{const a=t.map(o=>{var d;return(d=o==null?void 0:o.onInit)==null?void 0:d.call(o,u)}).filter(Boolean);return new ae(l,u,f,Object.assign({},...a))},[]);return c.options=u,c.pluginImpls=t.map(a=>a(c,u)),z(()=>{if(!s&&n){const a=c.state.params||e.defaultParams||[];c.run(...a)}}),E(()=>{c.cancel()}),{cancel:p(c.cancel.bind(c)),data:c.state.data,error:c.state.error,loading:c.state.loading,mutate:p(c.mutate.bind(c)),params:c.state.params||[],refresh:p(c.refresh.bind(c)),refreshAsync:p(c.refreshAsync.bind(c)),run:p(c.run.bind(c)),runAsync:p(c.runAsync.bind(c))}}function he(r,e,t){return ce(r,e,[te,re,ne,ie,oe,M,ee,ue])}export{he as u};
